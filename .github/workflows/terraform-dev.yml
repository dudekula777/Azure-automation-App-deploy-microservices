name: 1 - Terraform Infrastructure

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths: 
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ENVIRONMENT: 'dev'
  TF_WORKING_DIR: 'infrastructure/environments/dev'

jobs:
  terraform:
    name: 'Terraform - Provision Infrastructure'
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.6.0'

    - name: Terraform Format
      id: fmt
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check -recursive
      continue-on-error: true

    - name: Terraform Init
      id: init
      run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

    - name: Terraform Validate
      id: validate
      run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

    - name: Terraform Plan
      id: plan
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} plan \
          -var="environment=${{ env.ENVIRONMENT }}" \
          -input=false \
          -out=tfplan

    - name: Terraform Apply - Phase 1 (Resource Group & Storage)
      id: apply-phase1
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve \
          -target=module.resource_group \
          -target=module.storage

    - name: Wait for Resource Group Propagation
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Waiting 15 seconds for resource group to be fully propagated..."
        sleep 15

    - name: Terraform Apply - Phase 2 (Network & ACR)
      id: apply-phase2
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve \
          -target=module.network \
          -target=module.acr

    - name: Wait for Network Resources
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Waiting 30 seconds for network resources to be fully provisioned..."
        sleep 30

    - name: Terraform Apply - Phase 3 (AKS)
      id: apply-phase3
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Deploying AKS cluster - this may take 10-15 minutes..."
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=module.aks

    - name: Full Infrastructure Apply (if needed)
      id: apply-full
      if: failure() && (steps.apply-phase3.outcome == 'failure')
      run: |
        echo "Phase-based deployment failed, attempting full apply..."
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve

    - name: Get AKS Outputs
      id: outputs
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        cd ${{ env.TF_WORKING_DIR }}
        
        # Get outputs with fallbacks
        AKS_CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "NOT_CREATED")
        AKS_RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "NOT_CREATED")
        ACR_NAME=$(terraform output -raw acr_name 2>/dev/null || echo "NOT_CREATED")
        KUBE_CONFIG=$(terraform output -raw kube_config 2>/dev/null || echo "NOT_AVAILABLE")
        
        echo "AKS_CLUSTER_NAME=$AKS_CLUSTER_NAME" >> $GITHUB_ENV
        echo "AKS_RESOURCE_GROUP=$AKS_RESOURCE_GROUP" >> $GITHUB_ENV
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        
        # Mask kubeconfig in logs
        echo "KUBE_CONFIG<<EOF" >> $GITHUB_ENV
        echo "$KUBE_CONFIG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "AKS Cluster: $AKS_CLUSTER_NAME"
        echo "Resource Group: $AKS_RESOURCE_GROUP"
        echo "ACR Name: $ACR_NAME"

    - name: Update GitHub Environment
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        echo "Infrastructure deployment completed successfully!"
        echo "AKS Cluster: ${{ env.AKS_CLUSTER_NAME }}"
        echo "Resource Group: ${{ env.AKS_RESOURCE_GROUP }}"
        echo "ACR: ${{ env.ACR_NAME }}"

    - name: Create Deployment Tag
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "Infrastructure deployed at $(date)" > infrastructure-deployment-$TIMESTAMP.txt
        echo "AKS Cluster: ${{ env.AKS_CLUSTER_NAME }}" >> infrastructure-deployment-$TIMESTAMP.txt
        echo "Resource Group: ${{ env.AKS_RESOURCE_GROUP }}" >> infrastructure-deployment-$TIMESTAMP.txt
        echo "ACR: ${{ env.ACR_NAME }}" >> infrastructure-deployment-$TIMESTAMP.txt
        echo "Environment: ${{ env.ENVIRONMENT }}" >> infrastructure-deployment-$TIMESTAMP.txt

    - name: Upload Infrastructure Details
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      uses: actions/upload-artifact@v4
      with:
        name: infrastructure-details
        path: infrastructure-deployment-*.txt
        retention-days: 30

    - name: Setup Kubectl
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && env.AKS_CLUSTER_NAME != 'NOT_CREATED'
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.29.0' # Match your AKS version

    - name: Configure Kubectl
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && env.AKS_CLUSTER_NAME != 'NOT_CREATED'
      run: |
        # Save kubeconfig to file
        mkdir -p ~/.kube
        echo "${{ env.KUBE_CONFIG }}" > ~/.kube/config
        
        # Verify cluster connection
        kubectl cluster-info
        kubectl get nodes

    - name: Test Cluster Connectivity
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && env.AKS_CLUSTER_NAME != 'NOT_CREATED'
      run: |
        echo "Testing AKS cluster connectivity..."
        kubectl get nodes -o wide
        kubectl get namespaces