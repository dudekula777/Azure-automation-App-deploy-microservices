name: 1 - Terraform Infrastructure

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths: 
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ENVIRONMENT: 'dev'
  TF_WORKING_DIR: 'infrastructure/environments/dev'

jobs:
  terraform:
    name: 'Terraform - Provision Infrastructure'
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.6.0'

    - name: Terraform Format
      id: fmt
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check -recursive
      continue-on-error: true

    - name: Terraform Init
      id: init
      run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

    - name: Terraform Validate
      id: validate
      run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

    - name: Terraform Plan
      id: plan
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} plan \
          -var="environment=${{ env.ENVIRONMENT }}" \
          -input=false \
          -out=tfplan

    - name: Terraform Apply - Phase 1 (Resource Group)
      id: apply-phase1
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=module.resource_group

    - name: Wait for Resource Group Propagation
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Waiting 15 seconds for resource group to be fully propagated..."
        sleep 15

    - name: Terraform Apply - Phase 2 (Network, Storage, ACR)
      id: apply-phase2
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve \
          -target=module.network \
          -target=module.storage \
          -target=module.acr

    - name: Wait for Network Resources
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        echo "Waiting 30 seconds for network resources to be fully provisioned..."
        sleep 30

    - name: Terraform Apply - Phase 3 (AKS)
      id: apply-phase3
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=module.aks

    - name: Get AKS Outputs
      id: outputs
      # Only run if apply was successful
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        cd ${{ env.TF_WORKING_DIR }}
        
        # Extract outputs with better error handling
        AKS_CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "NOT_CREATED")
        AKS_RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "NOT_CREATED")
        ACR_NAME=$(terraform output -raw acr_name 2>/dev/null || echo "NOT_CREATED")
        AKS_KUBECONFIG=$(terraform output -raw kube_config 2>/dev/null || echo "NOT_AVAILABLE")
        
        echo "AKS_CLUSTER_NAME=$AKS_CLUSTER_NAME" >> $GITHUB_ENV
        echo "AKS_RESOURCE_GROUP=$AKS_RESOURCE_GROUP" >> $GITHUB_ENV
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        
        echo "AKS Cluster: $AKS_CLUSTER_NAME"
        echo "Resource Group: $AKS_RESOURCE_GROUP"
        echo "ACR Name: $ACR_NAME"
        
        # Create kubeconfig file if available
        if [ "$AKS_KUBECONFIG" != "NOT_AVAILABLE" ] && [ "$AKS_KUBECONFIG" != "" ]; then
          echo "$AKS_KUBECONFIG" > kubeconfig
          echo "Kubeconfig saved for cluster: $AKS_CLUSTER_NAME"
        fi

    - name: Update GitHub Environment
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        echo "Infrastructure deployment completed successfully!"
        echo "AKS Cluster: ${{ env.AKS_CLUSTER_NAME }}"
        echo "Resource Group: ${{ env.AKS_RESOURCE_GROUP }}"
        echo "ACR: ${{ env.ACR_NAME }}"
        echo "Next step: Run Docker Build pipeline"

    - name: Create Deployment Tag
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        echo "Infrastructure deployed at $(date)" > infrastructure-deployment.txt
        echo "AKS Cluster: ${{ env.AKS_CLUSTER_NAME }}" >> infrastructure-deployment.txt
        echo "Resource Group: ${{ env.AKS_RESOURCE_GROUP }}" >> infrastructure-deployment.txt
        echo "ACR: ${{ env.ACR_NAME }}" >> infrastructure-deployment.txt
        echo "Terraform Version: 1.6.0" >> infrastructure-deployment.txt
        echo "Deployment Trigger: ${{ github.event_name }}" >> infrastructure-deployment.txt

    - name: Upload Infrastructure Details
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      uses: actions/upload-artifact@v4
      with:
        name: infrastructure-details
        path: |
          infrastructure-deployment.txt
          ${{ env.TF_WORKING_DIR }}/tfplan
        retention-days: 30

    - name: Upload Kubeconfig
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      uses: actions/upload-artifact@v4
      with:
        name: kubeconfig
        path: kubeconfig
        retention-days: 1  # Short retention for security.