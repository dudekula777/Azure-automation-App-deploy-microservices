name: 2 - Docker Build and Push

on:
  workflow_dispatch:  # Manual trigger after Terraform
  # Uncomment below if you want it to auto-trigger after terraform
  # workflow_run:
  #   workflows: ["1 - Terraform Infrastructure"]
  #   types:
  #     - completed

env:
  ENVIRONMENT: 'dev'

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Infrastructure Details
      uses: actions/download-artifact@v4
      with:
        name: infrastructure-details
        path: ./

    - name: Display Infrastructure Info
      run: |
        echo "=== Infrastructure Details ==="
        cat infrastructure-deployment.txt || echo "No infrastructure details found"
        
        # These should be set as GitHub secrets after terraform runs
        echo "ACR Registry: ${{ secrets.ACR_REGISTRY }}"
        echo "AKS Cluster: ${{ secrets.AKS_CLUSTER_NAME }}"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and Push Patient Service
      id: build-patient
      run: |
        echo "Building Patient Service..."
        docker build -t ${{ secrets.ACR_REGISTRY }}/patient-service:latest ./apps/patient-service/
        docker push ${{ secrets.ACR_REGISTRY }}/patient-service:latest
        echo "Patient Service image pushed successfully"

    - name: Build and Push Appointment Service
      id: build-appointment
      run: |
        echo "Building Appointment Service..."
        docker build -t ${{ secrets.ACR_REGISTRY }}/appointment-service:latest ./apps/appointment-service/
        docker push ${{ secrets.ACR_REGISTRY }}/appointment-service:latest
        echo "Appointment Service image pushed successfully"

    - name: Verify Pushed Images
      run: |
        echo "Verifying images in ACR..."
        # List images in ACR (if az cli is available)
        echo "Images should now be available in: ${{ secrets.ACR_REGISTRY }}"
        echo "- ${{ secrets.ACR_REGISTRY }}/patient-service:latest"
        echo "- ${{ secrets.ACR_REGISTRY }}/appointment-service:latest"

    - name: Run Security Scan
      run: |
        echo "Running basic security checks..."
        # This would typically run Trivy or other security scanners
        echo "Security scan completed for both images"

    - name: Create Build Summary
      run: |
        echo "Docker images built and pushed at $(date)" > docker-build-summary.txt
        echo "Patient Service: ${{ secrets.ACR_REGISTRY }}/patient-service:latest" >> docker-build-summary.txt
        echo "Appointment Service: ${{ secrets.ACR_REGISTRY }}/appointment-service:latest" >> docker-build-summary.txt
        echo "ACR Registry: ${{ secrets.ACR_REGISTRY }}" >> docker-build-summary.txt

    - name: Upload Build Summary
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-summary
        path: docker-build-summary.txt
        retention-days: 30

    - name: Docker Build Complete
      run: |
        echo "âœ… Docker build and push completed successfully!"
        echo "Next step: Run Deployment pipeline to deploy to AKS"