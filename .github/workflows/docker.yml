name: 2 - Docker Build and Push

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["1 - Terraform Infrastructure"]
    types:
      - completed

env:
  ENVIRONMENT: 'dev'

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: dev
    
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure CLI
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.ARM_CLIENT_ID }}
        tenant-id: ${{ secrets.ARM_TENANT_ID }}
        subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    - name: Get ACR Credentials
      id: acr-creds
      run: |
        # Update with your actual ACR name and resource group
        ACR_NAME="acrdev7459df5c"
        RESOURCE_GROUP="rg-dev-ab993d7f"
        
        # Enable admin user
        az acr update -n $ACR_NAME --resource-group $RESOURCE_GROUP --admin-enabled true
        
        # Get credentials
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "username" -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "passwords[0].value" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "loginServer" -o tsv)
        
        # Set outputs
        echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT
        echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        
        echo "ACR Registry: $ACR_LOGIN_SERVER"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      run: |
        echo "${{ steps.acr-creds.outputs.password }}" | docker login ${{ steps.acr-creds.outputs.login-server }} -u ${{ steps.acr-creds.outputs.username }} --password-stdin

    - name: Build and Push Patient Service
      run: |
        docker buildx build \
          --push \
          --tag ${{ steps.acr-creds.outputs.login-server }}/patient-service:latest \
          --file ./apps/patient-service/Dockerfile \
          ./apps/patient-service/
        echo "Patient Service image pushed successfully"

    - name: Build and Push Appointment Service
      run: |
        docker buildx build \
          --push \
          --tag ${{ steps.acr-creds.outputs.login-server }}/appointment-service:latest \
          --file ./apps/appointment-service/Dockerfile \
          ./apps/appointment-service/
        echo "Appointment Service image pushed successfully"

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: |
          ${{ steps.acr-creds.outputs.login-server }}/patient-service:latest
          ${{ steps.acr-creds.outputs.login-server }}/appointment-service:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Create Build Summary
      run: |
        echo "Docker images built and pushed at $(date)" > docker-build-summary.txt
        echo "Patient Service: ${{ steps.acr-creds.outputs.login-server }}/patient-service:latest" >> docker-build-summary.txt
        echo "Appointment Service: ${{ steps.acr-creds.outputs.login-server }}/appointment-service:latest" >> docker-build-summary.txt

    - name: Upload Build Summary
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-summary
        path: docker-build-summary.txt
        retention-days: 30

    - name: Docker Build Complete
      run: |
        echo "âœ… Docker build and push completed successfully!"