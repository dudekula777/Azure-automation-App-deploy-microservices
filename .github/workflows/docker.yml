name: 2 - Docker Build and Push

on:
  workflow_dispatch:  # Manual trigger

env:
  ENVIRONMENT: 'dev'

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    environment: dev
    
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history and tags

    - name: Debug Repository Structure
      run: |
        echo "=== Current Directory ==="
        pwd
        ls -la
        
        echo "=== Apps Directory ==="
        ls -la apps/
        
        echo "=== Patient Service Contents ==="
        ls -la apps/patient-service/ || echo "Patient service directory not found"
        
        echo "=== Appointment Service Contents ==="
        ls -la apps/appointment-service/ || echo "Appointment service directory not found"
        
        echo "=== Check Dockerfile Existence ==="
        find . -name "Dockerfile" -type f | head -20
        
        echo "=== Check if files actually exist ==="
        [ -f "apps/patient-service/Dockerfile" ] && echo "Patient Dockerfile EXISTS" || echo "Patient Dockerfile MISSING"
        [ -f "apps/appointment-service/Dockerfile" ] && echo "Appointment Dockerfile EXISTS" || echo "Appointment Dockerfile MISSING"

    - name: Show Dockerfile Contents
      run: |
        echo "=== Patient Service Dockerfile ==="
        cat apps/patient-service/Dockerfile || echo "Cannot read patient Dockerfile"
        
        echo "=== Appointment Service Dockerfile ==="
        cat apps/appointment-service/Dockerfile || echo "Cannot read appointment Dockerfile"

    - name: Login to Azure CLI with Service Principal
      run: |
        az login --service-principal \
          -u ${{ secrets.ARM_CLIENT_ID }} \
          -p ${{ secrets.ARM_CLIENT_SECRET }} \
          --tenant ${{ secrets.ARM_TENANT_ID }}
        
        az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}

    - name: Get ACR Credentials
      id: acr-creds
      run: |
        ACR_NAME="acrdev7459df5c"
        RESOURCE_GROUP="rg-dev-ab993d7f"
        
        echo "Getting ACR credentials for: $ACR_NAME in resource group: $RESOURCE_GROUP"
        
        # Enable admin user
        az acr update -n $ACR_NAME --resource-group $RESOURCE_GROUP --admin-enabled true
        
        # Get credentials
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "username" -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "passwords[0].value" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "loginServer" -o tsv)
        
        # Set outputs
        echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT
        echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        
        echo "ACR Registry: $ACR_LOGIN_SERVER"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      run: |
        echo "${{ steps.acr-creds.outputs.password }}" | docker login ${{ steps.acr-creds.outputs.login-server }} -u ${{ steps.acr-creds.outputs.username }} --password-stdin

    - name: Test Build with Absolute Paths
      run: |
        echo "=== Testing build with absolute paths ==="
        pwd
        ls -la apps/patient-service/Dockerfile
        
        # Try building with full path
        docker buildx build \
          --push \
          --tag ${{ steps.acr-creds.outputs.login-server }}/patient-service:test \
          --file $(pwd)/apps/patient-service/Dockerfile \
          $(pwd)/apps/patient-service/

    - name: Build and Push Services (Alternative Method)
      run: |
        echo "=== Building services ==="
        
        # Method 1: Using full paths
        echo "Building Patient Service..."
        docker buildx build \
          --push \
          --tag ${{ steps.acr-creds.outputs.login-server }}/patient-service:latest \
          --file ./apps/patient-service/Dockerfile \
          ./apps/patient-service/ || echo "Patient build failed"
        
        echo "Building Appointment Service..."
        docker buildx build \
          --push \
          --tag ${{ steps.acr-creds.outputs.login-server }}/appointment-service:latest \
          --file ./apps/appointment-service/Dockerfile \
          ./apps/appointment-service/ || echo "Appointment build failed"

    - name: Create Build Summary
      run: |
        echo "Docker build attempt completed at $(date)" > docker-build-summary.txt
        echo "ACR Registry: ${{ steps.acr-creds.outputs.login-server }}" >> docker-build-summary.txt

    - name: Upload Build Summary
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-summary
        path: docker-build-summary.txt
        retention-days: 30