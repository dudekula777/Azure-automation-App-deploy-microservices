name: End-to-End CI/CD Pipeline

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ main ]

env:
  # Azure Service Principal Credentials
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  
  # Environment Configuration
  ENVIRONMENT: dev
  NAMESPACE: healthcare-dev
  TF_WORKING_DIR: infrastructure/environments/dev

jobs:
  # ============================================================
  # STAGE 1: Terraform Infrastructure Provisioning
  # ============================================================
  terraform-infrastructure:
    name: 1 - Terraform Infrastructure
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      aks-cluster-name: ${{ steps.outputs.outputs.cluster-name }}
      aks-resource-group: ${{ steps.outputs.outputs.resource-group }}
      acr-name: ${{ steps.outputs.outputs.acr-name }}
      acr-login-server: ${{ steps.outputs.outputs.acr-login-server }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format
        id: fmt
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

      - name: Terraform Validate
        id: validate
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -input=false \
            -out=tfplan

      - name: Terraform Apply - Phase 1 (Resource Group)
        id: apply-phase1
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=module.resource_group

      - name: Wait for Resource Group Propagation
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Waiting 15 seconds for resource group to be fully propagated..."
          sleep 15

      - name: Terraform Apply - Phase 2 (Network, Storage, ACR)
        id: apply-phase2
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve \
            -target=module.network \
            -target=module.storage \
            -target=module.acr

      - name: Wait for Network Resources
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Waiting 30 seconds for network resources to be fully provisioned..."
          sleep 30

      - name: Terraform Apply - Phase 3 (AKS)
        id: apply-phase3
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=module.aks

      - name: Get Infrastructure Outputs
        id: outputs
        if: |
          (steps.apply-phase1.outcome == 'success' || steps.apply-phase1.outcome == 'skipped') &&
          (steps.apply-phase2.outcome == 'success' || steps.apply-phase2.outcome == 'skipped') && 
          (steps.apply-phase3.outcome == 'success' || steps.apply-phase3.outcome == 'skipped') &&
          (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
        run: |
          cd ${{ env.TF_WORKING_DIR }}
          AKS_CLUSTER_NAME=$(terraform output -raw cluster_name)
          AKS_RESOURCE_GROUP=$(terraform output -raw resource_group_name)
          ACR_NAME=$(terraform output -raw acr_name)
          ACR_LOGIN_SERVER=$(terraform output -raw acr_login_server)
          
          echo "cluster-name=$AKS_CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "resource-group=$AKS_RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "acr-name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr-login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Create Infrastructure Summary
        if: steps.outputs.outcome == 'success'
        run: |
          echo "Infrastructure deployed at $(date)" > infrastructure-deployment.txt
          echo "AKS Cluster: ${{ steps.outputs.outputs.cluster-name }}" >> infrastructure-deployment.txt
          echo "Resource Group: ${{ steps.outputs.outputs.resource-group }}" >> infrastructure-deployment.txt
          echo "ACR: ${{ steps.outputs.outputs.acr-name }}" >> infrastructure-deployment.txt
          echo "ACR Login Server: ${{ steps.outputs.outputs.acr-login-server }}" >> infrastructure-deployment.txt

      - name: Upload Infrastructure Details
        if: steps.outputs.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-details
          path: infrastructure-deployment.txt
          retention-days: 30

  # ============================================================
  # STAGE 2: Docker Build and Push
  # ============================================================
  docker-build-push:
    name: 2 - Docker Build and Push
    runs-on: ubuntu-latest
    environment: dev
    needs: terraform-infrastructure
    if: needs.terraform-infrastructure.result == 'success'
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug File Structure in Detail
        run: |
          echo "=== COMPREHENSIVE FILE STRUCTURE ANALYSIS ==="
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "Current directory: $(pwd)"
          ls -la apps/patient-service/
          cat apps/patient-service/Dockerfile || echo "Cannot read Dockerfile"

      - name: Login to Azure CLI with Service Principal
        run: |
          az login --service-principal \
            -u ${{ secrets.ARM_CLIENT_ID }} \
            -p ${{ secrets.ARM_CLIENT_SECRET }} \
            --tenant ${{ secrets.ARM_TENANT_ID }}
          az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Get ACR Credentials
        id: acr-creds
        run: |
          ACR_NAME="${{ needs.terraform-infrastructure.outputs.acr-name }}"
          RESOURCE_GROUP="${{ needs.terraform-infrastructure.outputs.aks-resource-group }}"
          az acr update -n $ACR_NAME --resource-group $RESOURCE_GROUP --admin-enabled true
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "passwords[0].value" -o tsv)
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Log in to Azure Container Registry
        run: |
          echo "${{ steps.acr-creds.outputs.password }}" | docker login ${{ needs.terraform-infrastructure.outputs.acr-login-server }} \
            -u ${{ steps.acr-creds.outputs.username }} --password-stdin
      - name: Build and Push Patient Service
        run: |
            echo "Building Patient Service Docker image..."
            cd $GITHUB_WORKSPACE/apps/patient-service
            echo "Current directory: $(pwd)"
            ls -la
            cat Dockerfile || echo "Dockerfile missing!"
            docker build -f Dockerfile -t ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/patient-service:latest .
            docker push ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/patient-service:latest
        
      - name: Build and Push Appointment Service
        run: |
            echo "Building Appointment Service Docker image..."
            cd $GITHUB_WORKSPACE/apps/appointment-service
            echo "Current directory: $(pwd)"
            ls -la
            cat Dockerfile || echo "Dockerfile missing!"
            docker build -f Dockerfile -t ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/appointment-service:latest .
            docker push ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/appointment-service:latest
            
    #   - name: Install Trivy
    #     run: |
    #         echo "Installing Trivy vulnerability scanner..."
    #         sudo apt-get update -y
    #         sudo apt-get install -y wget apt-transport-https gnupg lsb-release
    #         wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    #         echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
    #         sudo apt-get update -y
    #         sudo apt-get install -y trivy

    #   - name: Run Trivy vulnerability scanner
    #     run: |
    #       docker pull ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/patient-service:latest
    #       docker pull ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/appointment-service:latest
    #       trivy image --format sarif --output trivy-results.sarif \
    #         ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/patient-service:latest \
    #         ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/appointment-service:latest

    #   - name: Run Trivy Image Scan
    #     run: |
    #         docker pull acrdev7459df5c.azurecr.io/patient-service:latest
    #         docker pull acrdev7459df5c.azurecr.io/appointment-service:latest
    #         trivy image --format sarif --output trivy-results.sarif \
    #         acrdev7459df5c.azurecr.io/patient-service:latest \
    #         acrdev7459df5c.azurecr.io/appointment-service:latest

    #   - name: Upload Trivy scan results to GitHub Security tab
    #     uses: github/codeql-action/upload-sarif@v3
    #     with:
    #       sarif_file: trivy-results.sarif

      - name: Create Build Summary
        run: |
          echo "Docker images built and pushed at $(date)" > docker-build-summary.txt
          echo "Patient Service: ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/patient-service:latest" >> docker-build-summary.txt
          echo "Appointment Service: ${{ needs.terraform-infrastructure.outputs.acr-login-server }}/appointment-service:latest" >> docker-build-summary.txt

      - name: Upload Build Summary
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-summary
          path: docker-build-summary.txt
          retention-days: 30

  # ============================================================
  # STAGE 3: Deploy to AKS
  # ============================================================
  deploy-to-aks:
    name: 3 - Deploy to AKS
    runs-on: ubuntu-latest
    environment: dev
    needs:
      - terraform-infrastructure
      - docker-build-push
    if: |
      needs.terraform-infrastructure.result == 'success' && 
      needs.docker-build-push.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Summary
        uses: actions/download-artifact@v4
        with:
          name: docker-build-summary
          path: ./

      - name: Login to Azure CLI
        run: |
          az login --service-principal \
            -u ${{ secrets.ARM_CLIENT_ID }} \
            -p ${{ secrets.ARM_CLIENT_SECRET }} \
            --tenant ${{ secrets.ARM_TENANT_ID }}
          az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ needs.terraform-infrastructure.outputs.aks-resource-group }} \
            --name ${{ needs.terraform-infrastructure.outputs.aks-cluster-name }} \
            --overwrite-existing

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.13.0

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
# âœ… Add this step
      - name: Build Helm dependencies
        run: |
          echo "Building Helm dependencies..."
          helm dependency build ./kubernetes/helm

      - name: Deploy Healthcare Microservices
        run: |
          helm lint ./kubernetes/helm
        
          helm upgrade --install healthcare-microservices ./kubernetes/helm \
          --namespace healthcare-dev \
          --create-namespace \
          --set global.imageRegistry=acrdev7459df5c.azurecr.io \
          --set global.environment=dev \
          --wait --timeout 600s

  # ============================================================
  # STAGE 4: Pipeline Summary
  # ============================================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - terraform-infrastructure
      - docker-build-push
      - deploy-to-aks
    if: always()
    steps:
      - name: Pipeline Status
        run: |
          echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Infrastructure | ${{ needs.terraform-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build & Push | ${{ needs.docker-build-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AKS Deployment | ${{ needs.deploy-to-aks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.terraform-infrastructure.result }}" == "success" && \
                "${{ needs.docker-build-push.result }}" == "success" && \
                "${{ needs.deploy-to-aks.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All stages completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline failed in one or more stages**" >> $GITHUB_STEP_SUMMARY
          fi
