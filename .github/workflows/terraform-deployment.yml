name: Terraform AKS DEV Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: terraform-deploy
  cancel-in-progress: true

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.4

      - name: Terraform Init
        run: terraform init -reconfigure
        working-directory: ./infra

      - name: Terraform Validate
        run: terraform validate
        working-directory: ./infra

      - name: Terraform Format
        run: terraform fmt -check
        working-directory: ./infra

      - name: Terraform Plan
        run: terraform plan \
          -var "client_id=${{ secrets.AZURE_CLIENT_ID }}" \
          -var "client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
          -var "subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -var "tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
          -var "aks_resource_group=${{ secrets.AKS_RESOURCE_GRP }}" \
          -var "storage_account_name=${{ secrets.STORAGE_ACCOUNT }}" \
          -var "aks_acr_name=${{ secrets.ACR_NAME }}" \
          -var "cluster_name=${{ secrets.AKS_CLUSTER }}"
        working-directory: ./infra

      - name: Terraform Apply
        run: terraform apply -auto-approve \
          -var "client_id=${{ secrets.AZURE_CLIENT_ID }}" \
          -var "client_secret=${{ secrets.AZURE_CLIENT_SECRET }}" \
          -var "subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -var "tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
          -var "aks_resource_group=${{ secrets.AKS_RESOURCE_GRP }}" \
          -var "storage_account_name=${{ secrets.STORAGE_ACCOUNT }}" \
          -var "aks_acr_name=${{ secrets.ACR_NAME }}" \
          -var "cluster_name=${{ secrets.AKS_CLUSTER }}"
        working-directory: ./infra

  build-and-deploy:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Azure Login (Service Principal)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and push Docker images (DEV)
        run: |
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/appointment-service:dev ./services/appointment-service
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/appointment-service:dev
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/patient-service:dev ./services/patient-service
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/patient-service:dev

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set AKS context
        run: az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GRP }} --name ${{ secrets.AKS_CLUSTER }}

      - name: Attach ACR to AKS
        run: az aks update --name ${{ secrets.AKS_CLUSTER }} --resource-group ${{ secrets.AKS_RESOURCE_GRP }} --attach-acr ${{ secrets.ACR_NAME }}

      - name: Assign Network Contributor role
        shell: bash
        run: |
          NODE_RG=$(az aks show -g "${{ secrets.AKS_RESOURCE_GRP }}" -n "${{ secrets.AKS_CLUSTER }}" --query nodeResourceGroup -o tsv)
          KUBELET_ID=$(az aks show -g "${{ secrets.AKS_RESOURCE_GRP }}" -n "${{ secrets.AKS_CLUSTER }}" --query identityProfile.kubeletidentity.objectId -o tsv)
          SCOPE_ID=$(az group show -n "$NODE_RG" --query id -o tsv)
          az role assignment create --assignee "$KUBELET_ID" --role "Network Contributor" --scope "$SCOPE_ID"

      - name: Install NGINX Ingress Controller
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --set controller.service.loadBalancerIP=${{ secrets.AKS_PUB_IP }} \
            --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"=${{ secrets.AKS_RESOURCE_GRP }} \
            --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-pip-name"=${{ secrets.AKS_PUB_IP_NAME }}

      - name: Deploy App + Ingress (DEV)
        run: |
          cd k8s
          kubectl apply -f appointment-deployment.yml
          kubectl apply -f appointment-service.yml
          kubectl apply -f patient-deployment.yml
          kubectl apply -f patient-service.yml
          kubectl apply -f ingress.yml
